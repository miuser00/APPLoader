# APP Loader 设计文档

## APP Loader 由两部分构成

### 1 升级包生成器

#### 功能：
1. 负责生成7z格式的压缩包，可以供用户选择包含新版本APP的全部，或部分安装文件。
2. 负责生成xml格式的升级配置文件，配置文件包括了软件的版本号，压缩包下载url，说明文档url，以及压缩包的MD5 128bit签名。 还包括了跳过的文件及文件夹列表，这些文件将在引导程序升级时被跳过。另外配置文件还包含升级成功后是否弹窗等其他配置信息。
3. 提供升级说明文件的编辑功能，用来描述升级内容，供升级成功后弹窗使用。

### 2 程序引导及升级程序

1. 负责联网检测最新版本的软件是否存在。
2. 当前主程序是最新版时，直接启动主程序，并退出。
3. 当服务端存在更新的版本时后台静默下载压缩包，并解压等缩待升级。
4. 当本地升级程序环境准备好时，升级程序。
5. 升级完成后根据升级配置信息决定是否弹窗提示升级成功。
6. 继续启动主程序，并退出。

## 更新包内容

- 用户需要提供一个http文件服务器，并上传升级包。升级包由三个文件构成"
	- 程序安装目录的7z压缩包 （mide_verxxx.7z)
	- xml格式的文件，包含安装版本号，压缩包哈希值，不需要更新的文件名单等基本信息(upgrade.xml)
	- md格式的更新说明文件(upgrade.md)

## 程序更新流程


- 当升级准备好标志"ready.flag"不存在时表示缓冲区内没有待更新的版本，升级程序检查服务器的是否有更新的软件包供下载，主程序继续运行。
- 如果检查发现有更新的软件包，则启动下载程序开始更新包到下载更新区，并退出升级程序。
- 当升级准备好标志"ready.flag"存在时，表示缓冲区有待更新的版本，升级程序完成应用升级。
	- 升级流程首先计算md5签名是否OK，如果不OK，丢弃本次升级文件
	- 如果OK，则完成升级流程，并重新启动主程序
	- 升级流程开始前，先保存需要跳过的文件，然后解压缩覆盖所有文件，再把预先保存的文件复制回来
- 升级完成后，根绝配置文件决定是否弹窗提示升级成功
- 继续启动主程序

## 目录结构

- 生成端

	- app (应用程序目录)
		- Bin32 应用的程序文件夹
			- 7za.exe 压缩解压缩程序
			- app.exe 主程序
		- uppack 升级用文件夹
			- downlaod 下载的升级文件包
			- zipped 解压缩待升级的程序目录
			- ready.flag (待升级的标志文件)
			- upgrade.xml (服务器的最新的升级配置文件，包含MD5签名)
		- Config 用户配置文件
		- document 文档
		- firmware soc固件
		- license 版权信息
		- lua Lua脚本文件
		- plugin 打开文件的插件应用
		- AppLoader.exe 引导文件

	- InstallPackage
		- app 待打包的升级文件包
		- upgrade.xml (生成的升级配置文件，不包含MD5签名)
		- upgrade.md (升级说明文件)


